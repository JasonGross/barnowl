
# $Id$

srcdir = @srcdir@
VPATH = @srcdir@

prefix = @prefix@
exec_prefix = @exec_prefix@

datadir = @datadir@
bindir = @bindir@
mandir = @mandir@

CC=@CC@
LIBS=@LIBS@
#CFLAGS=@CFLAGS@ @DEFS@
CFLAGS=@CFLAGS@ -DDATADIR=\"${datadir}\"
LDFLAGS=@LDFLAGS@
XSUBPPDIR=@XSUBPPDIR@
INSTALL = @INSTALL@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_DATA = @INSTALL_DATA@

OBJS=list.o message.o mainwin.o popwin.o zephyr.o messagelist.o commands.o \
     global.o text.o fmtext.o editwin.o util.o logging.o readconfig.o keys.o \
     functions.o zwrite.o viewwin.o help.o filter.o regex.o history.o view.o \
     dict.o variable.o varstubs.o filterelement.o pair.o \
     keypress.o keymap.o keybinding.o cmd.o context.o perlglue.o zcrypt.o

AUTOGEN=owl_prototypes.h varstubs.c perlglue.c

owl: $(AUTOGEN) $(OBJS) owl.o
	./athstatic $(CC) -o owl owl.o $(OBJS) $(LDFLAGS) $(LIBS)

tester: $(AUTOGEN) $(OBJS) tester.o
	$(CC) -o tester tester.o $(OBJS) $(LDFLAGS) $(LIBS)

test: tester
	./tester reg

clean:
	$(RM) owl tester *.o $(AUTOGEN) owl_prototypes.h.new

distclean: clean
	$(RM) config.cache config.log config.status Makefile config.h TAGS *~ core

proto: owl_prototypes.h

perlglue.c: perlglue.xs
	perl $(XSUBPPDIR)/xsubpp -typemap $(XSUBPPDIR)/typemap -prototypes perlglue.xs > perlglue.c

varstubs.c: variable.c stubgen.pl
	perl stubgen.pl > varstubs.c

all: owl

install: all installdirs
	${INSTALL_PROGRAM} owl ${bindir}/owl
	${INSTALL_DATA} doc/owl.1 ${mandir}/man1/owl.1

installdirs: mkinstalldirs
	${srcdir}/mkinstalldirs ${bindir} ${mandir}/man1 ${datadir}/owl

# Only move owl_prototypes.h into place if the new one is different
owl_prototypes.h: codelist.pl varstubs.c $(OBJS:.o=.c)
	perl codelist.pl | grep -v ZWRITEOPTIONS > owl_prototypes.h.new
	@cmp -s owl_prototypes.h.new owl_prototypes.h || echo 'Interfaces changed!'
	@cmp -s owl_prototypes.h.new owl_prototypes.h || mv -f owl_prototypes.h.new owl_prototypes.h

tags:
	etags *.[ch]

*.o:: owl.h config.h owl_prototypes.h
